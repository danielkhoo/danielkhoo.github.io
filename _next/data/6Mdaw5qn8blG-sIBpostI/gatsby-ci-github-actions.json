{"pageProps":{"post":{"title":"Deploy Gatsby on commit with Github Actions","date":"2019-12-16T00:00:00.000Z","slug":"gatsby-ci-github-actions","content":"<h2>The Dumb Way</h2>\n<p>For the longest time, ever since I first learned about Github Actions, I've wanted a quick easy way to automate deployment for this Gatsby blog.</p>\n<p>The idea is simple yet beautiful.</p>\n<ol>\n<li>Edit Markdown</li>\n<li>Commit</li>\n<li><em>Magic</em></li>\n</ol>\n<p>Gatsby build already deploys static files, so the only real challenge is pushing it to the github.io repo. Of course the lazy way is simply to git init in the directory, set origin and <em><strong>FORCE PUSH!!!!</strong></em>.</p>\n<div class=\"remark-highlight\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token string\">\"deploy\"</span><span class=\"token builtin class-name\">:</span> <span class=\"token string\">\"gatsby build &#x26;&#x26; cd public &#x26;&#x26; git add . &#x26;&#x26; git commit -m 'deploy' &#x26;&#x26; git push --force\"</span>\n</code></pre></div>\n<p><em><em>Obi wan has taught me well</em></em></p>\n<h2>The Fancy Way</h2>\n<p>The previous way works, but it's not very pretty. Kinda like hammering a nail with a big rock. Why are we building and pushing the artifacts locally when we have fancy <em>Github Actions</em> to do this for us?</p>\n<p>Turns out setting up a github action is really simple. All you need is a YAML file.</p>\n<p><code>.github/deploy.yml</code></p>\n<div class=\"remark-highlight\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> CI <span class=\"token punctuation\">-</span> Build and Deploy to Github Pages Repo\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>push<span class=\"token punctuation\">]</span>\n\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n<span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span>\n<span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v1\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\"></span>\n<span class=\"token scalar string\">          npm install</span>\n<span class=\"token scalar string\">          npm run build</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Deploy\n        <span class=\"token key atrule\">env</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">ACCESS_TOKEN</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.ACCESS_TOKEN <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\"></span>\n<span class=\"token scalar string\">          cd ${{ github.workspace }}/public</span>\n<span class=\"token scalar string\">          git init</span>\n<span class=\"token scalar string\">          git add .</span>\n<span class=\"token scalar string\">          git config --local user.email \"action@github.com\"</span>\n<span class=\"token scalar string\">          git config --local user.name \"GitHub Action\"</span>\n<span class=\"token scalar string\">          git commit -m \"Build artifacts\"</span>\n<span class=\"token scalar string\">          git remote add origin https://$ACCESS_TOKEN@github.com/danielkhoo/danielkhoo.github.io.git</span>\n<span class=\"token scalar string\">          git push --set-upstream origin master --force</span>\n</code></pre></div>\n<p>Note that I had to generate a separate ACCESS_TOKEN to access the other repo.</p>\n<p><code>GitHub Settings / Developer settings / Personal access tokens</code></p>\n<p>Once generated, add it as a secret in the current repo under <code>Settings / Secrets</code></p>\n<blockquote>\n<p>And that's it! Automatic Gatsby build and deploy on push. Magic</p>\n</blockquote>\n<p><img src=\"./ss2.png\" alt=\"CI\"></p>\n"}},"__N_SSG":true}